<!DOCTYPE html>
<html>
<head>
    <title>高级IRR计算器（自动更新版）</title>
    <style>
        .input-group { margin: 10px; }
        label { display: inline-block; width: 200px; }
    </style>
</head>
<body>
    <h2>高级IRR计算器（自动更新版）</h2>
    
    <!-- 输入参数 -->
    <div class="input-group">
        <label>供款年数：</label>
        <input type="number" id="payment-years" value="5" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>每年供款金额：</label>
        <input type="number" id="annual-payment" value="12810" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>开始提取年份：</label>
        <input type="number" id="withdrawal-start" value="6" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>提取次数：</label>
        <input type="number" id="withdrawal-years" value="14" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>每次提取金额：</label>
        <input type="number" id="withdrawal-amount" value="3843" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>回报年份：</label>
        <input type="number" id="final-year" value="20" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>最终回報金額：</label>
        <input type="number" id="final-amount" value="65620" onchange="calculateAdvancedIRR()">
    </div>

    <div id="result" style="margin-top: 20px; color: blue;"></div>

    <script>
        function calculateAdvancedIRR() {
            try {
                // 获取输入参数
                const paymentYears = parseInt(document.getElementById('payment-years').value);
                const annualPayment = parseFloat(document.getElementById('annual-payment').value);
                const withdrawalStart = parseInt(document.getElementById('withdrawal-start').value);
                const withdrawalTimes = parseInt(document.getElementById('withdrawal-years').value);
                const withdrawalAmount = parseFloat(document.getElementById('withdrawal-amount').value);
                const finalYear = parseInt(document.getElementById('final-year').value);
                const finalAmount = parseFloat(document.getElementById('final-amount').value);

                // 输入验证
                const withdrawalEnd = withdrawalStart + withdrawalTimes - 1;
                if (withdrawalEnd > finalYear) { // 修正条件为 >=
                    throw new Error("提取结束年份不得大于总年数！");
                }

                // 构建现金流数组（关键修正：年份索引从1开始）
                const cashFlows = Array.from({ length: finalYear }, () => 0); // 初始化为0

                // 供款期：第1年到第paymentYears年
                for (let i = 1; i <= paymentYears; i++) {
                    cashFlows[i] = -annualPayment;
                }

                // 提取期：第withdrawalStart年到第withdrawalEnd年
                for (let i = withdrawalStart; i <= withdrawalEnd; i++) {
                    cashFlows[i] = withdrawalAmount;
                }

                // 最终年：第finalYear年
                cashFlows[finalYear] = finalAmount;

                console.log("修正后现金流数组:", cashFlows);

                // 计算IRR（算法优化）
                const irr = precisionIRRCalculation(cashFlows);
                document.getElementById('result').innerHTML = 
                    `内部回报率 (IRR): <strong>${(irr * 100).toFixed(2)}%</strong>`;

            } catch (error) {
                alert('错误: ' + error.message);
            }
        }

        // 优化后的IRR算法
        function precisionIRRCalculation(cashFlows) {
            let rate = 0.05; // 初始猜测值调整为5%
            const precision = 1e-8;
            const maxIterations = 1000;

            for (let i = 0; i < maxIterations; i++) {
                let npv = 0.0, derivative = 0.0;
                cashFlows.forEach((cf, t) => {
                    const discountFactor = 1 / Math.pow(1 + rate, t);
                    npv += cf * discountFactor;
                    derivative += -cf * t * discountFactor / (1 + rate);
                });

                if (Math.abs(npv) < precision) break;
                rate -= npv / derivative;
            }
            return rate;
        }
    </script>
</body>
</html><!DOCTYPE html>
<html>
<head>
    <title>高级IRR计算器（自动更新版）</title>
    <style>
        .input-group { margin: 10px; }
        label { display: inline-block; width: 200px; }
    </style>
</head>
<body>
    <h2>高级IRR计算器（自动更新版）</h2>
    
    <!-- 输入参数 -->
    <div class="input-group">
        <label>供款年数：</label>
        <input type="number" id="payment-years" value="5" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>每年供款金额：</label>
        <input type="number" id="annual-payment" value="12810" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>开始提取年份：</label>
        <input type="number" id="withdrawal-start" value="6" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>提取次数：</label>
        <input type="number" id="withdrawal-years" value="14" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>每次提取金额：</label>
        <input type="number" id="withdrawal-amount" value="3843" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>回报年份：</label>
        <input type="number" id="final-year" value="20" onchange="calculateAdvancedIRR()">
    </div>
    <div class="input-group">
        <label>最终回報金額：</label>
        <input type="number" id="final-amount" value="65620" onchange="calculateAdvancedIRR()">
    </div>

    <div id="result" style="margin-top: 20px; color: blue;"></div>

    <script>
        function calculateAdvancedIRR() {
            try {
                // 获取输入参数
                const paymentYears = parseInt(document.getElementById('payment-years').value);
                const annualPayment = parseFloat(document.getElementById('annual-payment').value);
                const withdrawalStart = parseInt(document.getElementById('withdrawal-start').value);
                const withdrawalTimes = parseInt(document.getElementById('withdrawal-years').value);
                const withdrawalAmount = parseFloat(document.getElementById('withdrawal-amount').value);
                const finalYear = parseInt(document.getElementById('final-year').value);
                const finalAmount = parseFloat(document.getElementById('final-amount').value);

                // 输入验证
                const withdrawalEnd = withdrawalStart + withdrawalTimes - 1;
                if (withdrawalEnd > finalYear) { // 修正条件为 >=
                    throw new Error("提取结束年份不得大于总年数！");
                }

                // 构建现金流数组（关键修正：年份索引从1开始）
                const cashFlows = Array.from({ length: finalYear }, () => 0); // 初始化为0

                // 供款期：第1年到第paymentYears年
                for (let i = 1; i <= paymentYears; i++) {
                    cashFlows[i] = -annualPayment;
                }

                // 提取期：第withdrawalStart年到第withdrawalEnd年
                for (let i = withdrawalStart; i <= withdrawalEnd; i++) {
                    cashFlows[i] = withdrawalAmount;
                }

                // 最终年：第finalYear年
                cashFlows[finalYear] = finalAmount;

                console.log("修正后现金流数组:", cashFlows);

                // 计算IRR（算法优化）
                const irr = precisionIRRCalculation(cashFlows);
                document.getElementById('result').innerHTML = 
                    `内部回报率 (IRR): <strong>${(irr * 100).toFixed(2)}%</strong>`;

            } catch (error) {
                alert('错误: ' + error.message);
            }
        }

        // 优化后的IRR算法
        function precisionIRRCalculation(cashFlows) {
            let rate = 0.05; // 初始猜测值调整为5%
            const precision = 1e-8;
            const maxIterations = 1000;

            for (let i = 0; i < maxIterations; i++) {
                let npv = 0.0, derivative = 0.0;
                cashFlows.forEach((cf, t) => {
                    const discountFactor = 1 / Math.pow(1 + rate, t);
                    npv += cf * discountFactor;
                    derivative += -cf * t * discountFactor / (1 + rate);
                });

                if (Math.abs(npv) < precision) break;
                rate -= npv / derivative;
            }
            return rate;
        }
    </script>
</body>
</html>
